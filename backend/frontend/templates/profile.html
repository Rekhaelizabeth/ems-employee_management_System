{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Profile</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <style>
    .container{max-width:720px;margin:6rem auto;padding:2rem;background:#111a2b;border-radius:1.2rem}
    .card{background:#0e1930;border:1px solid #1e2a45;padding:1rem;border-radius:1rem;margin-top:1rem}
    .row{display:flex;gap:1rem;flex-wrap:wrap;margin-top:1rem}
    .kv{display:grid;grid-template-columns: 180px 1fr;gap:.6rem 1rem}
    .k{color:#a7b3cf}
    .pill{display:inline-block;padding:.15rem .5rem;border:1px solid #33425f;border-radius:.5rem;font-size:.9rem}
    .note{color:#a7b3cf}
    .btn{border:0;border-radius:.7rem;padding:.8rem 1rem;cursor:pointer;font-weight:600}
    .btn-primary{background:#4da3ff;color:#061223}
    .btn-ghost{background:transparent;border:1px solid #263148;color:#e9eefb}
    .btn-danger{background:#d9534f;color:#fff;border-color:#b94441}
    .btn-danger[disabled]{opacity:.7;cursor:not-allowed}
    .btn-danger:hover{filter:brightness(1.05)}

    /* Admin card grid */
    .admin-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap:1rem;
    }
    .user-card{
      background:#0c172b;
      border:1px solid #1e2a45;
      border-radius:1rem;
      padding:1rem;
    }
    .user-card h4{ margin:.2rem 0 .6rem 0; color:#e9eefb; }
    .kv-mini{ display:grid; grid-template-columns: 110px 1fr; gap:.4rem .8rem; }
    .k-mini{ color:#a7b3cf; }
  </style>

  <!-- Axios and your API client -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="{% static 'app-axios.js' %}"></script>
</head>
<body>
  <div class="container">
    <h1>My Profile</h1>

    <div class="row">
      <a class="btn btn-ghost" href="/">Home</a>
      <button id="btnLogout" class="btn btn-primary" type="button">Logout</button>
    </div>

    <div id="basic" class="card">
      <h3 style="margin-top:0">Account</h3>
      <div class="kv">
        <div class="k">Username</div><div id="v-username" class="v"></div>
        <div class="k">Email</div><div id="v-email" class="v"></div>
      </div>
    </div>

    <div id="extrasCard" class="card" style="display:none">
      <h3 style="margin-top:0">Details</h3>
      <div id="extras" class="kv"></div>
    </div>

    <!-- ADMIN PANEL (hidden unless admin) -->
    <div id="adminPanel" class="card" style="display:none;">
      <div class="row" style="margin-top:0">
        <h3 style="margin:0">All Users</h3>
        <div id="adminSummary" class="note" style="margin-left:auto;"></div>
      </div>

      <div class="row">
        <input id="adminSearch" placeholder="Search by username/email/extra…" style="flex:1" />
        <button id="adminClear" class="btn btn-ghost" type="button">Clear</button>
      </div>

      <div id="adminMsg" class="note" style="margin-top:.5rem;">Loading users…</div>

      <div id="adminGrid" class="admin-grid" style="margin-top:1rem;">
        <!-- user cards render here -->
      </div>
    </div>

    <div id="msg" class="note" style="margin-top:1rem;"></div>
  </div>

  <script>
    // ---------------- Logout ----------------
    document.addEventListener("DOMContentLoaded", () => {
      const btnLogout = document.getElementById("btnLogout");
      btnLogout?.addEventListener("click", () => {
        try {
          if (window.apiClient?.clearTokens) window.apiClient.clearTokens();
          else localStorage.removeItem("tokens");
        } finally {
          window.location.href = "/";
        }
      });
    });

    // --------------- Profile loader ---------------
    async function loadProfile(){
      const msg = document.getElementById("msg");
      const vUser = document.getElementById("v-username");
      const vEmail = document.getElementById("v-email");
      const extrasWrap = document.getElementById("extras");
      const extrasCard = document.getElementById("extrasCard");

      msg.textContent = "Loading profile…";

      try {
        let data;
        if (window.apiClient && typeof window.apiClient.getProfile === "function") {
          data = await window.apiClient.getProfile();
        } else {
          const tokens = JSON.parse(localStorage.getItem("tokens") || "{}");
          const res = await axios.get("http://127.0.0.1:8000/api/auth/profile/", {
            headers: { Authorization: `Bearer ${tokens.access}` }
          });
          data = res.data;
        }

        // basic fields
        vUser.textContent = data.username ?? "-";
        vEmail.textContent = data.email ?? "-";

        // dynamic extras: everything except username/email/admin flags
        const entries = Object.entries(data).filter(([k]) =>
          k !== "username" && k !== "email" && k !== "is_superuser" && k !== "is_staff"
        );
        if (entries.length) {
          extrasCard.style.display = "";
          extrasWrap.innerHTML = entries.map(([k, v]) => `
            <div class="k">${escapeHtml(prettyLabel(k))}</div>
            <div class="v"><span class="pill">${escapeHtml(String(v ?? ""))}</span></div>
          `).join("");
        } else {
          extrasCard.style.display = "none";
        }

        msg.textContent = "";

        // if admin/superuser, load admin panel
        await maybeLoadAdminPanel(data);
      } catch (e) {
        if (e?.response?.status === 401) {
          msg.innerHTML = `Please <a class="btn btn-primary" href="/auth/#login">log in</a> to view your profile.`;
        } else {
          msg.textContent = e?.response?.data?.detail || e.message || "Failed to load profile.";
        }
      }
    }

    // --------------- Admin panel (cards + DELETE) ---------------
    async function maybeLoadAdminPanel(me) {
      const isAdmin = (me?.username === "admin") || !!me?.is_superuser;
      if (!isAdmin) return;

      const panel  = document.getElementById("adminPanel");
      const msg    = document.getElementById("adminMsg");
      const grid   = document.getElementById("adminGrid");
      const sum    = document.getElementById("adminSummary");
      const search = document.getElementById("adminSearch");
      const clear  = document.getElementById("adminClear");

      panel.style.display = "";      // show panel
      msg.textContent = "Loading users…";

      try {
        // Fetch all users with extras from the admin API
        let users;
        if (window.apiClient?.api) {
          const res = await window.apiClient.api.get("/admin/users/");
          users = res.data;
        } else {
          const tokens = JSON.parse(localStorage.getItem("tokens") || "{}");
          const res = await axios.get("http://127.0.0.1:8000/api/admin/users/", {
            headers: { Authorization: `Bearer ${tokens.access}` }
          });
          users = res.data;
        }

        // Initial render
        renderAdminCards(users);

        // Filter wiring
        const doFilter = () => {
          const q = (search.value || "").toLowerCase();
          const filtered = users.filter(u => {
            const base = `${u.username||""} ${u.email||""}`.toLowerCase();
            const exts = Object.entries(u.extras || {})
              .map(([k,v]) => `${k} ${v}`)
              .join(" ")
              .toLowerCase();
            return base.includes(q) || exts.includes(q);
          });
          renderAdminCards(filtered);
        };
        search?.addEventListener("input", doFilter);
        clear?.addEventListener("click", () => { search.value = ""; doFilter(); });

        // Delegate delete button clicks
        grid.addEventListener("click", async (e) => {
          const btn = e.target.closest(".btn-danger[data-id]");
          if (!btn) return;
          const id = Number(btn.dataset.id);
          const name = btn.dataset.name || "";
          if (!confirm(`Delete user "${name}"? This cannot be undone.`)) return;
          const original = btn.textContent;
          btn.disabled = true;
          btn.textContent = "Deleting…";
          try {
            await deleteUser(id);
            // remove from local array, then re-apply current filter
            users = users.filter(u => u.id !== id);
            doFilter();
          } catch (err) {
            msg.textContent = err?.response?.data?.detail || err.message || "Delete failed.";
            btn.disabled = false;
            btn.textContent = original;
          }
        });

        function renderAdminCards(list) {
          sum.textContent = `${list.length} user${list.length===1?"":"s"}`;
          if (!list.length) {
            grid.innerHTML = "";
            msg.textContent = "No users match the current filter.";
            return;
          }
          msg.textContent = "";
          grid.innerHTML = list.map(u => {
            const extrasEntries = Object.entries(u.extras || {});
            const extrasHtml = extrasEntries.length
              ? extrasEntries.map(([k,v]) => `
                  <div class="k-mini">${escapeHtml(prettyLabel(k))}</div>
                  <div class="v"><span class="pill">${escapeHtml(String(v ?? ""))}</span></div>
                `).join("")
              : `<div class="note">No extra fields.</div>`;

            // hide delete for yourself or superusers
            const canDelete = (u.username !== me.username) && !u.is_superuser;

            return `
              <div class="user-card">
                <h4>${escapeHtml(u.username || "")}</h4>
                <div class="kv-mini" style="margin-bottom:.5rem">
                  <div class="k-mini">Email</div><div>${escapeHtml(u.email || "-")}</div>
                </div>
                <div class="kv-mini">
                  ${extrasHtml}
                </div>
                <div class="row" style="margin-top:.8rem">
                  ${canDelete
                    ? `<button class="btn btn-danger" data-id="${u.id}" data-name="${escapeHtml(u.username)}">Delete</button>`
                    : `<span class="note">Protected</span>`}
                </div>
              </div>
            `;
          }).join("");
        }

        async function deleteUser(id) {
          if (window.apiClient?.api) {
            await window.apiClient.api.delete(`/admin/users/${id}/`);
          } else {
            const tokens = JSON.parse(localStorage.getItem("tokens") || "{}");
            await axios.delete(`http://127.0.0.1:8000/api/admin/users/${id}/`, {
              headers: { Authorization: `Bearer ${tokens.access}` }
            });
          }
        }

      } catch (e) {
        msg.textContent = e?.response?.data?.detail || e.message || "Failed to load users.";
      }
    }

    // --------------- Helpers ---------------
    function prettyLabel(s){
      return String(s).replace(/_/g, ' ').replace(/\b\w/g, ch => ch.toUpperCase());
    }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Run on load
    document.addEventListener("DOMContentLoaded", () => {
      loadProfile();
    });
  </script>
</body>
</html>
